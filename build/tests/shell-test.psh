#! /usr/bin/env pdo-shell

## Copyright 2018 Intel Corporation
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.

set --conditional -s data -v .
set --conditional -s save -v .
set --conditional -s service_host -v ${host}

if --null "${tmpfile}"
   echo must specify tmpfile for test
   exit -v -1
fi

## some definitions to make it easier to display text
set -s ENDC   -v "\033[0m"
set -s BOLD   -v '\033[1m'
set -s HEADER -v "\033[95m"
set -s ERROR  -v "\033[91m"
set -s WARN   -v "\033[93m"
set -s INFO   -v "\033[92m"

## echo running tests on ${service_host}

## -----------------------------------------------------------------
echo ${HEADER}create the initial service database ${ENDC}
## -----------------------------------------------------------------
## create an eservice db with the known enclave services
service_db clear
service_db add --type eservice --url http://${service_host}:7101 --name eservice1
service_db add --type eservice --url http://${service_host}:7102 --name eservice2
service_db add --type eservice --url http://${service_host}:7103 --name eservice3
service_db add --type eservice --url http://${service_host}:7104 --name eservice4
service_db add --type eservice --url http://${service_host}:7105 --name eservice5

service_db add --type pservice --url http://${service_host}:7001 --name pservice1
service_db add --type pservice --url http://${service_host}:7002 --name pservice2
service_db add --type pservice --url http://${service_host}:7003 --name pservice3
service_db add --type pservice --url http://${service_host}:7004 --name pservice4
service_db add --type pservice --url http://${service_host}:7005 --name pservice5

service_db add --type sservice --url http://${service_host}:7201 --name sservice1
service_db add --type sservice --url http://${service_host}:7202 --name sservice2
service_db add --type sservice --url http://${service_host}:7203 --name sservice3
service_db add --type sservice --url http://${service_host}:7204 --name sservice4
service_db add --type sservice --url http://${service_host}:7205 --name sservice5

## -----------------------------------------------------------------
echo ${HEADER}create the initial groups database ${ENDC}
## -----------------------------------------------------------------
service_groups clear

set -s persistent_storage_service -v http://${service_host}:7201

pservice create --group default --name pservice1 pservice2 pservice3
pservice create --group p1 --name pservice3 pservice4 pservice5
pservice create --group all --name pservice1 pservice2 pservice3 pservice4 pservice5

eservice create --group default --name eservice1 eservice2 eservice3
eservice create --group e1 --name eservice3 eservice4 eservice5
eservice create --group all --name eservice1 eservice2 eservice3 eservice4 eservice5

sservice create --group default --name sservice1 sservice2 sservice3
sservice set --group default --duration 120 --replicas 2 --persistent ${persistent_storage_service}

sservice create --group s1 --name sservice3 sservice4 sservice5
sservice set --group s1 --duration 120 --replicas 2 --persistent ${persistent_storage_service}

sservice create --group s2 --name sservice1 sservice2
sservice set --group s2 --duration 120 --replicas 1 --persistent ${persistent_storage_service}

sservice create --group all --name sservice1 sservice2 sservice3 sservice4 sservice5
sservice set --group all --duration 3600 --replicas 3 --persistent ${persistent_storage_service}

## create some contracts
set -s contract1 -r 32
set -s contract2 -r 32
set -s contract3 -r 32
set -s contract4 -r 32

identity -n user1
contract create -c mock-contract --source _mock-contract -f ${save}/${contract1}.pdo
contract send -f ${save}/${contract1}.pdo inc_value
contract send -f ${save}/${contract1}.pdo inc_value
contract send -f ${save}/${contract1}.pdo -s value inc_value
if -e ${value} 3
    echo shell test 1 succeeded
else
    echo shell test 1 failed
    exit -v -1
fi

identity -n user2
contract create -c mock-contract --source _mock-contract -r all -p all -e all -f ${save}/${contract2}.pdo
contract send -f ${save}/${contract2}.pdo --wait inc_value -e http://${service_host}:7101
contract send -f ${save}/${contract2}.pdo --wait inc_value -e http://${service_host}:7102
contract send -f ${save}/${contract2}.pdo --wait inc_value -e random
contract send -f ${save}/${contract2}.pdo --wait inc_value -e random
contract send -f ${save}/${contract2}.pdo get_value -s value
if -e ${value} 4
    echo shell test 2 succeeded
else
    echo shell test 2 failed
    exit -v -1
fi

identity -n user3
contract create -c mock-contract --source _mock-contract -r s1 -p p1 -e e1 -f ${save}/${contract3}.pdo
contract send -f ${save}/${contract3}.pdo inc_value -s r8 -e preferred
contract send -f ${save}/${contract3}.pdo inc_value -s r9 -e random
contract send -f ${save}/${contract3}.pdo inc_value -s r10 -e random
contract send -f ${save}/${contract3}.pdo get_value -s value
if -e ${value} 3
    echo shell test 3 succeeded
else
    echo shell test 3 failed
    exit -v -1
fi

identity -n user4
contract create -c mock-contract --source _mock-contract -r s2 -p p1 -e e1 -f ${save}/${contract4}.pdo
contract send -f ${save}/${contract4}.pdo inc_value -s v -e preferred
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo inc_value -s v -e random
contract send -f ${save}/${contract4}.pdo get_value -s value
if -e ${value} 10
    echo shell test 4 succeeded
else
    echo shell test 4 failed
    exit -v -1
fi

exit
